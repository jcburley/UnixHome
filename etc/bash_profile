#!/bin/bash

[ -r ~/.debug-profiles ] && echo "$0: bash_profile: running" && env

export BASH_PROFILE_HAS_RUN=true

export UNIXHOME=~/.unixhome

# Ensure 'path' utility is in $PATH.
if ! which path >/dev/null 2>&1; then
    for d in /usr/local/bin; do
        [ -x "$d/path" ] && PATH="${d}${PATH:+:${PATH}}"
    done
    if ! which path >/dev/null 2>&1; then
        echo >&2 "$0: $UNIXHOME/etc/bash_profile: ERROR: 'path' utility not in \$PATH"
        sleep 10  # So Windows shows the error before the window closes
        exit 99
    fi
fi

[ -f "$UNIXHOME"/etc/functions ] && . "$UNIXHOME"/etc/functions

# Pull in .profile, which e.g. MacPorts creates to prepend to $PATH.
[ -f ~/.profile ] && . ~/.profile

# Get the aliases and functions.
if [ -z "$BASHRC_HAS_RUN" ] && [ -f $HOME/.bashrc ]; then
    source $HOME/.bashrc
fi

PATHDIRS="$HOME/bin $HOME/googlesource/depot_tools"

for pd in $PATHDIRS; do
    [ -d "$pd" ] && PATH=$(path --append "$pd")
done

export PATH

# If system has a known manpath configuration file, ensure $MANPATH
# begins with a colon, which means use the config.  Otherwise, ensure
# it has certain canonical directories.

# Per 'brew install bash-completion' on Mac OS X:
[ -f /usr/local/etc/bash_completion ] && . /usr/local/etc/bash_completion

if [ -r /etc/man.conf -o -r /etc/manpath.config ]; then
    MANPATH="$(eval path \"$MANPATH\" --prepend \"\")"
else
    for d in /usr/man /usr/local/man /usr/share/man /usr/local/share/man /usr/X11/man /usr/X11R6/man /opt/man; do
        [ -d "$d" ] && MANPATH="$(eval path \"$MANPATH\" --append \"$d\")"
    done
fi

if [ -d /var/qmail/man ]; then
    MANPATH="$(eval path \"$MANPATH\" --append /var/qmail/man)"
fi

export GITBASE=git@github.com:jcburley

export MANPATH

if [ -n "$PS1" ]; then
    # Use Emacs if installed. (Git bash which does not support -s.)
    if which emacs >/dev/null 2>&1; then
        export EDITOR=emacs
        export GIT_EDITOR=emacs
        export VISUAL=emacs
    fi

    # Taken from /usr/share/bash-completion/bash_completion on my
    # Ubuntu 16.04 system, substituting "pushd" for "cd":
    if shopt -q cdable_vars; then
        complete -v -F _cd -o nospace pushd
    else
        complete -F _cd -o nospace pushd
    fi

    # Don't export CDPATH, and set it only for interactive sessions, per:
    #   https://bosker.wordpress.com/2012/02/12/bash-scripters-beware-of-the-cdpath/
    CDPATH=$(eval path \"\" --prepend .)
    CDPATH=$(eval path \"$CDPATH\" --append ~/github)
    CDPATH=$(eval path \"$CDPATH\" --append ~/gitdove)

    # Get git goodness in prompts. See bashrc for PS1 and PROMPT_COMMAND
    # definitions including $SHLVL. NOTE: __git_ps1 rewrites $PS1!!
    export PS1='[\u@\h \W$(__git_ps1 " (%s)")]\$ '
    export PROMPT_COMMAND='__git_ps1 "\u@\h:\w" "\\\$ "'

    export GIT_PS1_SHOWDIRTYSTATE=t
    export GIT_PS1_SHOWSTASHSTATE=t
    export GIT_PS1_SHOWUPSTREAM="verbose"
fi

# GoLang
if [ -d /usr/local/go ]; then
    export GOROOT=/usr/local/go
    PATH=$(path --append $GOROOT/bin)
fi
if [ -d "$HOME/.go" ]; then
    export GOPATH=$HOME/.go
    export GOBIN="$GOPATH"/bin
    PATH=$(path --append $GOPATH/bin)
    if [ -n "$PS1" ]; then
        for d in "$GOPATH"/src/github.com/*; do
            CDPATH=$(eval path \"$CDPATH\" --append \"$d\")
        done
        CDPATH=$(eval path \"$CDPATH\" --append \"$GOPATH\"/src/github.com)
    fi
fi

# Pull in per-session profile, if any:
PSP=~/.unixhome/etc/sessions/${USER}@$(hostname)
[ -f $PSP/profile ] && . $PSP/profile
