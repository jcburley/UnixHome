#!/bin/sh

if [ -z "$MAC_EMACS" ]; then
    MAC_EMACS='/Applications/Emacs.app'
fi

# If no Mac OS X version installed, just invoke whatever is on $PATH.
if [ ! -d "$MAC_EMACS" ]; then
    PATH_COMMAND="$(which path)"
    MYPATH="$(dirname "$0")"
    TMP_PATH="$("$PATH_COMMAND" --remove "$MYPATH")"
    PATH="$TMP_PATH" "$PATH_COMMAND" # emacs "$@"
    exit $?
fi

EMACS_EXE='Contents/MacOS/Emacs'

if [ -n "$EMACS" ]; then
    "/Applications/$EMACS.app/${EMACS_EXE}" "$@"
    exit $?
fi

BASE="$(basename "$PWD")"
NEWBASE="$BASE"

while true; do
    EMACS="/Applications/$NEWBASE.app"

    if [ ! -e "$EMACS" ]; then
        break
    fi

    if [ -z $COUNT ]; then
        COUNT=1
    else
        COUNT=$((COUNT + 1))
    fi

    NEWBASE="($COUNT) $BASE"
done

ln -sv "$MAC_EMACS" "$EMACS"

echo "Starting: $EMACS"

"$EMACS/${EMACS_EXE}" "$@"

rm -f "$EMACS"
